<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Новогодняя Ностальгия — Генератор слайд‑шоу (Ken Burns + переходы + финал + iPhone)</title>
  <style>
    :root{
      --bg: #0a192f;
      --panel: rgba(17, 34, 64, 0.82);
      --panel-border: rgba(148, 163, 184, 0.35);
      --text: #e6f1ff;
      --muted: rgba(226, 232, 240, 0.75);
      --accent: #fbbf24;
      --accent-2: #1e3a8a;
      --ok: #22c55e;
      --shadow: 0 25px 60px rgba(0,0,0,0.35);
    }
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(30,58,138,0.45), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(251,191,36,0.18), transparent 55%),
                  linear-gradient(180deg, #061224, var(--bg));
      color: var(--text);
      overflow-x: hidden;
    }
    .container{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 16px 42px;
      position: relative;
      z-index: 2;
    }
    header{
      text-align:center;
      margin: 18px 0 22px;
    }
    header h1{
      margin: 0;
      font-size: clamp(28px, 4vw, 56px);
      letter-spacing: 0.5px;
      color: var(--accent);
      font-weight: 800;
    }
    header p{
      margin: 10px auto 0;
      max-width: 900px;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.5;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; gap: 22px; }
    }

    .step-title{
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      margin: 0 0 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
    }
    .subtle{
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 10px;
      line-height: 1.4;
    }

    .btn{
      appearance: none;
      border: none;
      cursor: pointer;
      font-weight: 800;
      border-radius: 10px;
      padding: 12px 14px;
      transition: transform 0.15s ease, filter 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
      display: inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      user-select: none;
      text-decoration: none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: var(--accent);
      color: #111827;
      box-shadow: 0 10px 30px rgba(251,191,36,0.2);
    }
    .btn-primary:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn-secondary{
      background: var(--accent-2);
      color: white;
    }
    .btn-secondary:hover{ filter: brightness(1.08); transform: translateY(-1px); }
    .btn-ghost{
      background: rgba(148,163,184,0.14);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.28);
    }
    .btn-ghost:hover{ filter: brightness(1.07); transform: translateY(-1px); }
    .btn[disabled]{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
      filter: none !important;
    }

    input[type="file"]{ display:none; }

    .uploader{
      display:flex;
      flex-direction: column;
      gap: 14px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
    }
    .file-status{
      font-size: 13px;
      color: var(--ok);
      text-align:center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .range-wrap{
      width: 100%;
      margin-top: 12px;
    }
    input[type="range"]{ width: 100%; accent-color: var(--accent); }
    .range-value{
      margin-top: 6px;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
    }

    .control-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(148,163,184,0.28);
    }
    @media (min-width: 520px){
      .control-grid{ grid-template-columns: 1fr 1fr; }
    }
    .control{
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.22);
      border-radius: 12px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 96px;
    }
    .control label{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 800;
      color: rgba(226,232,240,0.92);
      font-size: 13px;
    }
    .control small{ color: var(--muted); line-height: 1.35; }
    .control select{
      width:100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.28);
      background: rgba(2,6,23,0.48);
      color: rgba(226,232,240,0.92);
      outline: none;
    }
    .control input[type="checkbox"]{
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .drop-area{
      border: 2px dashed rgba(148,163,184,0.35);
      border-radius: 12px;
      padding: 14px;
      text-align:center;
      color: var(--muted);
      font-size: 13px;
      transition: border-color .2s ease, background-color .2s ease;
    }
    .drop-area.dragover{
      border-color: rgba(251,191,36,0.65);
      background: rgba(251,191,36,0.06);
      color: rgba(226,232,240,0.9);
    }

    .image-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.28);
      background: rgba(15, 23, 42, 0.45);
      min-height: 180px;
      max-height: 230px;
      overflow: auto;
    }
    @media (min-width: 520px){
      .image-grid{ grid-template-columns: repeat(4, 1fr); }
    }

    .empty{
      display:flex;
      align-items:center;
      justify-content:center;
      border: 2px dashed rgba(148,163,184,0.35);
      border-radius: 12px;
      height: 230px;
      color: var(--muted);
      font-size: 14px;
      padding: 18px;
      text-align:center;
    }

    .thumb{
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      overflow: hidden;
      cursor: grab;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.65);
      transition: transform 0.12s ease, opacity 0.12s ease, outline 0.12s ease;
    }
    .thumb.dragging{ opacity: 0.4; transform: scale(0.98); cursor: grabbing; }
    .thumb.drop-target{ outline: 2px solid rgba(251,191,36,0.6); outline-offset: 2px; }
    .thumb img{ width: 100%; height: 100%; object-fit: cover; display:block; }
    .thumb .overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,0);
      transition: background 0.2s ease;
    }
    .thumb:hover .overlay{ background: rgba(0,0,0,0.35); }

    .remove-btn{
      position: absolute;
      top: 6px; right: 6px;
      width: 28px; height: 28px;
      border-radius: 999px;
      border: none;
      background: rgba(0,0,0,0.45);
      color: white;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease, background 0.2s ease, transform 0.12s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thumb:hover .remove-btn{ opacity: 1; }
    .remove-btn:hover{ background: rgba(239,68,68,0.85); transform: translateY(-1px); }

    .footer{
      text-align:center;
      margin-top: 18px;
      color: rgba(148,163,184,0.8);
      font-size: 12px;
      line-height: 1.5;
    }

    .action-bar{
      margin-top: 16px;
      display:flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Snowflakes */
    .snow{ position: fixed; inset: 0; pointer-events:none; z-index: 1; overflow:hidden; }
    .flake{
      position: absolute;
      top: -10%;
      color: rgba(255,255,255,0.75);
      opacity: 0.9;
      user-select:none;
      will-change: transform;
      animation: fall linear infinite, sway ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(255,255,255,0.25));
    }
    @keyframes fall{ from { transform: translateY(-10vh); } to { transform: translateY(110vh); } }
    @keyframes sway{ 0%,100%{ margin-left: 0px; } 50%{ margin-left: 40px; } }
  </style>
</head>
<body>
  <div class="snow" id="snow"></div>

  <div class="container">
    <header>
      <h1>Новогодняя Ностальгия</h1>
      <p>Офлайн‑генератор: загрузите фото, добавьте музыку и скачайте “шоу” в виде одного HTML‑файла. Есть <b>Ken Burns</b> и набор <b>переходов</b>. Финал: последний кадр держится <b>10 секунд</b>, музыка начинает угасать через <b>3 секунды</b> на последнем кадре.</p>
    </header>

    <div class="panel">
      <div class="grid">
        <section>
          <h2 class="step-title">Шаг 1: Загрузите файлы</h2>

          <div class="uploader">
            <div>
              <label class="btn btn-secondary" for="imageUpload" style="width:100%;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 16V4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M7 9l5-5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 20h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Выбрать изображения
              </label>
              <input id="imageUpload" type="file" multiple accept="image/*" />
              <div class="hint">Можно выбрать несколько файлов</div>
            </div>

            <div class="drop-area" id="dropArea">
              Или перетащите изображения сюда (drag &amp; drop)
            </div>

            <div>
              <label class="btn btn-secondary" for="audioUpload" style="width:100%;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 18V5l12-2v13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="7" cy="18" r="3" stroke="currentColor" stroke-width="2"/>
                  <circle cx="19" cy="16" r="3" stroke="currentColor" stroke-width="2"/>
                </svg>
                Выбрать музыку (MP3)
              </label>
              <input id="audioUpload" type="file" accept="audio/mpeg,audio/mp3,audio/*" />
              <div class="file-status" id="audioStatus" style="display:none;"></div>
            </div>

            <div class="row">
              <button class="btn btn-ghost" id="clearAllBtn" type="button">Очистить всё</button>
              <span class="subtle" id="counterText">Изображений: 0</span>
            </div>
          </div>
        </section>

        <section>
          <h2 class="step-title">Шаг 2: Настройте шоу</h2>
          <p class="subtle">Перетащите фото, чтобы задать порядок. Переходы и Ken Burns применяются в сгенерированной презентации.</p>

          <div id="emptyState" class="empty">Здесь появятся ваши фото</div>
          <div id="imageGrid" class="image-grid" style="display:none;"></div>

          <div class="range-wrap">
            <label for="durationRange" class="subtle" style="display:block;margin-bottom:8px;">
              Время показа одного слайда (секунд):
            </label>
            <input id="durationRange" type="range" min="2" max="15" step="1" value="5" />
            <div class="range-value" id="durationValue">5 сек.</div>
          </div>

          <div class="control-grid" aria-label="Настройки эффектов">
            <div class="control">
              <label>
                <input id="kenBurnsToggle" type="checkbox" checked />
                Киношное движение (Ken Burns)
              </label>
              <small>Плавный зум и панорамирование на каждом слайде. Если включён “уменьшенный motion” в системе — эффект будет автоматически выключен.</small>
            </div>

            <div class="control">
              <label for="transitionSelect">Переход между слайдами</label>
              <select id="transitionSelect">
                <option value="random">Случайный (каждый слайд)</option>
                <option value="fade">Fade (мягкий)</option>
                <option value="dissolve">Dissolve (быстрее)</option>
                <option value="blur-fade">Blur‑fade</option>
                <option value="slide">Slide</option>
                <option value="zoom-cross">Zoom‑cross</option>
                <option value="film-cut">Film cut</option>
                <option value="polaroid-flip">Polaroid flip</option>
              </select>
              <small>Режим “Случайный” подбирает эффект на каждую смену кадра.</small>
            </div>
          </div>
        </section>
      </div>

      <div class="action-bar">
        <button class="btn btn-primary" id="generateBtn" type="button" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 12v10H4V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M2 7h20v5H2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 22V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 7c-2.2 0-4-1.3-4-3s1.8-3 4-3c1.3 0 2.5.5 3.2 1.3C16.5 1.5 17.7 1 19 1c2.2 0 4 1.3 4 3s-1.8 3-4 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Создать и Скачать
        </button>

        <button class="btn btn-ghost" id="previewBtn" type="button" disabled>
          Открыть презентацию в новой вкладке
        </button>
      </div>

      <div class="footer">
        <div>&copy; <span id="year"></span> С Новым Годом!</div>
        <div style="opacity:0.85;">Подсказка: музыка может не стартовать автоматически — браузер может требовать клик.</div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const yearEl = document.getElementById('year');
      yearEl.textContent = String(new Date().getFullYear());

      // --- Snowflakes (generator UI) ---
      const snow = document.getElementById('snow');
      const flakeCount = 22;
      const flakeChars = ['❄','✻','✼','❅'];
      for (let i=0; i<flakeCount; i++){
        const el = document.createElement('div');
        el.className = 'flake';
        el.textContent = flakeChars[Math.floor(Math.random()*flakeChars.length)];
        const size = 10 + Math.random()*14;
        const left = Math.random()*100;
        const fallDur = 8 + Math.random()*10;
        const swayDur = 3 + Math.random()*5;
        const delay = Math.random()*-fallDur;
        el.style.fontSize = size+'px';
        el.style.left = left+'%';
        el.style.animationDuration = fallDur+'s, '+swayDur+'s';
        el.style.animationDelay = delay+'s, '+(Math.random()*-swayDur)+'s';
        snow.appendChild(el);
      }

      const prefersReducedMotion = (function(){
        try { return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }
        catch(e){ return false; }
      })();

      // --- State ---
      const state = {
        images: [], // {id, name, dataUrl}
        audio: null, // {name, type, dataUrl}
        slideDuration: 5,
        kenBurns: !prefersReducedMotion,
        transition: 'random',
        lastGeneratedHtml: null,
      };

      // --- Elements ---
      const imageUpload = document.getElementById('imageUpload');
      const audioUpload = document.getElementById('audioUpload');
      const audioStatus = document.getElementById('audioStatus');
      const dropArea = document.getElementById('dropArea');

      const imageGrid = document.getElementById('imageGrid');
      const emptyState = document.getElementById('emptyState');

      const durationRange = document.getElementById('durationRange');
      const durationValue = document.getElementById('durationValue');

      const kenBurnsToggle = document.getElementById('kenBurnsToggle');
      const transitionSelect = document.getElementById('transitionSelect');

      const generateBtn = document.getElementById('generateBtn');
      const previewBtn = document.getElementById('previewBtn');
      const clearAllBtn = document.getElementById('clearAllBtn');
      const counterText = document.getElementById('counterText');

      // Init controls
      kenBurnsToggle.checked = state.kenBurns;
      transitionSelect.value = state.transition;

      function makeId(name){
        try {
          return (crypto.randomUUID ? crypto.randomUUID() : (name + '-' + Date.now() + '-' + Math.random().toString(16).slice(2)));
        } catch(_) {
          return name + '-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        }
      }

      function readFileAsDataURL(file){
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function setBusy(isBusy){
        generateBtn.disabled = isBusy || state.images.length === 0;
        imageUpload.disabled = isBusy;
        audioUpload.disabled = isBusy;
        clearAllBtn.disabled = isBusy;
        kenBurnsToggle.disabled = isBusy;
        transitionSelect.disabled = isBusy;

        previewBtn.disabled = isBusy || !state.lastGeneratedHtml;

        if (isBusy){
          generateBtn.textContent = 'Создание...';
        } else {
          generateBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 12v10H4V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M2 7h20v5H2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 22V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 7c-2.2 0-4-1.3-4-3s1.8-3 4-3c1.3 0 2.5.5 3.2 1.3C16.5 1.5 17.7 1 19 1c2.2 0 4 1.3 4 3s-1.8 3-4 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Создать и Скачать
          `;
        }
      }

      function updateCounter(){
        counterText.textContent = 'Изображений: ' + state.images.length;
      }

      function renderGrid(){
        updateCounter();
        const hasImages = state.images.length > 0;
        emptyState.style.display = hasImages ? 'none' : 'flex';
        imageGrid.style.display = hasImages ? 'grid' : 'none';

        generateBtn.disabled = state.images.length === 0;
        previewBtn.disabled = !state.lastGeneratedHtml;

        imageGrid.innerHTML = '';
        if (!hasImages) return;

        for (const img of state.images){
          const item = document.createElement('div');
          item.className = 'thumb';
          item.draggable = true;
          item.dataset.id = img.id;

          const image = document.createElement('img');
          image.src = img.dataUrl;
          image.alt = img.name || 'image';

          const overlay = document.createElement('div');
          overlay.className = 'overlay';

          const remove = document.createElement('button');
          remove.className = 'remove-btn';
          remove.type = 'button';
          remove.title = 'Удалить';
          remove.setAttribute('aria-label', 'Удалить ' + (img.name || 'изображение'));
          remove.innerHTML = '&#10005;';

          remove.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            state.images = state.images.filter(x => x.id !== img.id);
            if (state.images.length === 0) state.lastGeneratedHtml = null;
            renderGrid();
            setBusy(false);
          });

          // Drag & drop reorder
          item.addEventListener('dragstart', (e) => {
            item.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', img.id);
          });
          item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            for (const el of imageGrid.querySelectorAll('.drop-target')){
              el.classList.remove('drop-target');
            }
          });
          item.addEventListener('dragenter', (e) => { e.preventDefault(); item.classList.add('drop-target'); });
          item.addEventListener('dragleave', () => item.classList.remove('drop-target'));
          item.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
          item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.classList.remove('drop-target');
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = item.dataset.id;
            if (!draggedId || !targetId || draggedId === targetId) return;

            const arr = [...state.images];
            const from = arr.findIndex(x => x.id === draggedId);
            const to = arr.findIndex(x => x.id === targetId);
            if (from < 0 || to < 0) return;
            const [moved] = arr.splice(from, 1);
            arr.splice(to, 0, moved);
            state.images = arr;
            renderGrid();
          });

          item.appendChild(image);
          item.appendChild(overlay);
          item.appendChild(remove);

          imageGrid.appendChild(item);
        }
      }

      // --- Presentation HTML generator (Ken Burns + transitions + финальная задержка + fade-out) ---
      function generatePresentationHtml(images, audio, slideDurationSeconds, kenBurnsEnabled, transitionMode){
        const slidesHtml = images.map((dataUrl, idx) => {
          const active = idx === 0 ? 'active' : '';
          return `<div class="slide ${active}" data-idx="${idx}"><img class="media" src="${dataUrl}" alt="Слайд ${idx+1}"></div>`;
        }).join('');

        const audioPlayer = audio
          ? `<audio id="bg-music" loop preload="metadata">
              <source src="${audio.dataUrl}" type="${audio.type || 'audio/mpeg'}">
            </audio>`
          : '';

        // iOS/WebView audio unlock helper (very short silent WAV)
        const iosSilenceDataUrl = "data:audio/wav;base64,UklGRmQGAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YUAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
        const iosSilencePlayer = audio
          ? `<audio id="ios-silence" loop preload="auto" style="display:none">
              <source src="${iosSilenceDataUrl}" type="audio/wav">
            </audio>`
          : '';

        return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Новогодняя Презентация</title>
  <style>
    :root {
      --nav-button-bg: rgba(0, 0, 0, 0.30);
      --nav-button-hover-bg: rgba(0, 0, 0, 0.62);
      --nav-button-color: rgba(255, 255, 255, 0.74);
      --nav-button-hover-color: #ffffff;

      --transDur: 900ms;
      --slideSec: ${slideDurationSeconds}; /* будет перезаписываться на последнем кадре */
    }
    html, body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      background:#000;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
    }
    .slider-container{
      position:relative;
      width:100%;
      height:100%;
      background:#000;
      perspective: 900px;
    }

    .slide{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      z-index:1;
      will-change: opacity, transform, filter;
    }
    .slide.active{ opacity:1; z-index:2; }
    .slide.leaving{ opacity:1; z-index:3; }
    .slide.entering{ opacity:1; z-index:4; }

    .media{
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      user-select:none;
      pointer-events:none;
      will-change: transform, filter, opacity;
      transform: translate3d(0,0,0) scale(1);
    }

    /* --- Ken Burns --- */
    .kb-on .media.kb-anim{
      animation: kenburns var(--slideSec) linear both;
    }
    @keyframes kenburns{
      from{
        transform: translate3d(var(--kb-from-x, 0%), var(--kb-from-y, 0%), 0) scale(var(--kb-from-scale, 1.04));
      }
      to{
        transform: translate3d(var(--kb-to-x, 0%), var(--kb-to-y, 0%), 0) scale(var(--kb-to-scale, 1.14));
      }
    }

    /* --- Transitions --- */
    .tr-fade.entering{ animation: trFadeIn var(--transDur) ease both; }
    .tr-fade.leaving{ animation: trFadeOut var(--transDur) ease both; }
    @keyframes trFadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes trFadeOut{ from{opacity:1} to{opacity:0} }

    .tr-dissolve.entering{ animation: trDissolveIn 650ms ease both; }
    .tr-dissolve.leaving{ animation: trDissolveOut 650ms ease both; }
    @keyframes trDissolveIn{ from{opacity:0} to{opacity:1} }
    @keyframes trDissolveOut{ from{opacity:1} to{opacity:0} }

    .tr-blur-fade.entering{ animation: trBlurIn var(--transDur) ease both; }
    .tr-blur-fade.leaving{ animation: trBlurOut var(--transDur) ease both; }
    @keyframes trBlurIn{
      from{ opacity:0; filter: blur(16px); transform: translate3d(0,0,0) scale(1.03); }
      to{ opacity:1; filter: blur(0px); transform: translate3d(0,0,0) scale(1); }
    }
    @keyframes trBlurOut{
      from{ opacity:1; filter: blur(0px); transform: translate3d(0,0,0) scale(1); }
      to{ opacity:0; filter: blur(14px); transform: translate3d(0,0,0) scale(0.99); }
    }

    .tr-slide.entering{ animation: trSlideIn var(--transDur) cubic-bezier(.2,.8,.2,1) both; }
    .tr-slide.leaving{ animation: trSlideOut var(--transDur) cubic-bezier(.2,.8,.2,1) both; }
    @keyframes trSlideIn{
      from{ opacity:0; transform: translate3d(8%,0,0); }
      to{ opacity:1; transform: translate3d(0,0,0); }
    }
    @keyframes trSlideOut{
      from{ opacity:1; transform: translate3d(0,0,0); }
      to{ opacity:0; transform: translate3d(-8%,0,0); }
    }

    .tr-zoom-cross.entering{ animation: trZoomIn var(--transDur) cubic-bezier(.2,.8,.2,1) both; }
    .tr-zoom-cross.leaving{ animation: trZoomOut var(--transDur) cubic-bezier(.2,.8,.2,1) both; }
    @keyframes trZoomIn{
      from{ opacity:0; transform: translate3d(0,0,0) scale(1.08); }
      to{ opacity:1; transform: translate3d(0,0,0) scale(1); }
    }
    @keyframes trZoomOut{
      from{ opacity:1; transform: translate3d(0,0,0) scale(1); }
      to{ opacity:0; transform: translate3d(0,0,0) scale(0.98); }
    }

    /* Film cut */
    #flash{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.0);
      z-index:6;
      pointer-events:none;
      opacity:0;
    }
    #flash.fire{ animation: flash 280ms ease-out both; }
    @keyframes flash{
      0%{ opacity:0; background: rgba(255,255,255,0.0); }
      35%{ opacity:1; background: rgba(255,255,255,0.95); }
      100%{ opacity:0; background: rgba(255,255,255,0.0); }
    }
    .tr-film-cut.entering{ animation: trCutIn 180ms linear both; }
    .tr-film-cut.leaving{ animation: trCutOut 120ms linear both; }
    @keyframes trCutIn{ from{ opacity:0; filter: contrast(1.08) saturate(1.05);} to{ opacity:1; filter:none;} }
    @keyframes trCutOut{ from{ opacity:1; } to{ opacity:0; } }

    /* Polaroid flip */
    .tr-polaroid-flip.entering{
      transform-style: preserve-3d;
      animation: trFlipIn var(--transDur) cubic-bezier(.2,.8,.2,1) both;
    }
    .tr-polaroid-flip.leaving{
      transform-style: preserve-3d;
      animation: trFlipOut var(--transDur) cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes trFlipIn{
      from{ opacity:0; transform: rotateY(70deg) translate3d(0,0,0) scale(0.98); filter: blur(6px); }
      to{ opacity:1; transform: rotateY(0deg) translate3d(0,0,0) scale(1); filter: blur(0px); }
    }
    @keyframes trFlipOut{
      from{ opacity:1; transform: rotateY(0deg) translate3d(0,0,0) scale(1); filter: blur(0px); }
      to{ opacity:0; transform: rotateY(-70deg) translate3d(0,0,0) scale(0.98); filter: blur(6px); }
    }

    /* --- UI --- */
    .nav-button{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      background-color: var(--nav-button-bg);
      color: var(--nav-button-color);
      border:none;
      cursor:pointer;
      z-index:7;
      font-size:2rem;
      font-weight:800;
      transition: all 0.25s ease;
      border-radius: 999px;
      width: 60px;
      height: 60px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .nav-button:hover{
      background-color: var(--nav-button-hover-bg);
      color: var(--nav-button-hover-color);
    }
    .nav-button:disabled{
      opacity: 0.35;
      cursor: not-allowed;
    }
    .prev{ left: 15px; }
    .next{ right: 15px; }

    .credits{
      position:absolute;
      bottom: 20px;
      left:50%;
      transform: translateX(-50%);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size: 1.6rem;
      color: rgba(255,255,255,0.86);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      z-index:7;
      opacity:0;
      animation: fadeIn 2s 1s forwards;
      pointer-events:none;
    }
    @keyframes fadeIn{ to{ opacity:1; } }

    .progress-bar-container{
      position:absolute;
      bottom:0;
      left:0;
      width:100%;
      height: 5px;
      background: rgba(255,255,255,0.20);
      z-index:7;
    }
    .progress-bar{ height:100%; width:0; background: rgba(255,255,255,0.92); }
    .progress-bar.animate{ animation: progressBarAnimation var(--slideSec)s linear forwards; }
    @keyframes progressBarAnimation{ from{ width: 0; } to{ width: 100%; } }

    /* --- Sound control (bigger + label) --- */
    #sound-control{
      position:absolute;
      bottom: 22px;
      right: 22px;
      z-index: 8;
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 8px;
    }
    #player-control{
      background: var(--nav-button-bg);
      color: var(--nav-button-color);
      border:none;
      width: 88px;  /* x2 from 44 */
      height: 88px; /* x2 from 44 */
      border-radius: 999px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: background 0.25s ease, transform 0.12s ease;
      user-select:none;
    }
    #player-control:hover{ background: var(--nav-button-hover-bg); transform: translateY(-1px); }
    #sound-label{
      font-size: 12px;
      letter-spacing: 0.2px;
      color: rgba(255,255,255,0.78);
      text-shadow: 0 2px 12px rgba(0,0,0,0.65);
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 6px 10px;
      line-height: 1;
      opacity: 1;
      transition: opacity 0.2s ease;
    }
    #sound-label.hidden{ opacity: 0; }

    #hint{
      position:absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.35);
      color: rgba(255,255,255,0.8);
      font-size: 12px;
      z-index: 8;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #hint.visible{ opacity: 1; }

    /* --- Start overlay (mobile autoplay gate) --- */
    #start-overlay{
      position:absolute;
      inset:0;
      z-index: 9;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      padding: 18px;
    }
    #start-overlay.visible{ display:flex; }
    #start-card{
      width: min(420px, calc(100vw - 36px));
      border-radius: 18px;
      padding: 18px 16px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      text-align:center;
    }
    #start-card h2{
      margin:0 0 8px;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    #start-card p{
      margin:0 0 12px;
      font-size: 13px;
      color: rgba(255,255,255,0.78);
      line-height: 1.4;
    }
    #start-actions{
      display:flex;
      gap: 10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .start-btn{
      border: none;
      cursor:pointer;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 800;
      background: rgba(255,255,255,0.92);
      color: #111;
      min-width: 220px;
      transition: transform 0.12s ease, filter 0.2s ease, background 0.2s ease;
    }
    .start-btn:active{ transform: translateY(1px); }
    .start-btn:hover{ filter: brightness(1.03); }
    .start-btn.secondary{
      background: rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      border: 1px solid rgba(255,255,255,0.18);
    }
    #start-error{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,200,200,0.95);
      min-height: 16px;
    }

    .native-audio-fallback{
      display:none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.14);
      text-align:left;
    }
    .native-audio-fallback.visible{ display:block; }
    .native-audio-note{
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      margin-bottom: 8px;
      line-height: 1.35;
    }
    .native-audio-hint{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,0.65);
      line-height: 1.35;
    }
    #native-audio-slot audio{
      width: 100%;
      max-width: 520px;
    }

    
    /* --- No-JS / iOS Quick Look notice ---
       Some iOS built-in previewers (Quick Look in Mail/Files/messengers) disable JavaScript.
       In that case, the slideshow and buttons won't work. This overlay stays visible.
       When JS runs, we add body.js-ok and hide it.
    */
    #nojs-overlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.78);
      padding: 18px;
    }
    body.js-ok #nojs-overlay{ display: none; }
    #nojs-card{
      width: min(560px, calc(100vw - 36px));
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      padding: 16px 16px 14px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
    }
    #nojs-card h2{
      margin: 0 0 8px;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    #nojs-card p{
      margin: 0 0 10px;
      color: rgba(255,255,255,0.85);
      line-height: 1.4;
      font-size: 13px;
    }
    #nojs-card ol{
      margin: 0 0 0 18px;
      padding: 0;
      color: rgba(255,255,255,0.82);
      font-size: 13px;
      line-height: 1.45;
    }
    #nojs-card li{ margin: 4px 0; }
    #nojs-card .small{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.65);
      line-height: 1.35;
    }

@media (prefers-reduced-motion: reduce){
      :root{ --transDur: 1ms; }
      .kb-on .media.kb-anim{ animation: none !important; }
      .entering, .leaving{ animation: none !important; }
      #flash.fire{ animation: none !important; }
    }
  </style>
</head>
<body>
  <div id="nojs-overlay" aria-live="polite">
    <div id="nojs-card">
      <h2>Не запускается?</h2>
      <p>Если на экране ничего не меняется и кнопки не нажимаются, значит JavaScript не выполняется. На iPhone это часто бывает во встроенном предпросмотре (Quick Look) в «Файлах», «Почте» или мессенджерах — там JavaScript отключён.</p>
      <ol>
        <li>Нажмите «Поделиться».</li>
        <li>Выберите «Открыть в Safari» (или «Открыть в…» → Safari).</li>
        <li>После открытия в Safari нажмите «▶ включить звук» (или «Начать без звука»).</li>
      </ol>
      <div class="small">Если вы уже в Safari, проверьте: Настройки → Safari → Дополнения/Advanced → JavaScript (должен быть включён).</div>
    </div>
  </div>

  

  <div class="slider-container ${kenBurnsEnabled ? 'kb-on' : ''}" id="slider" data-transition-mode="${transitionMode}">
    ${slidesHtml}
    <div id="flash" aria-hidden="true"></div>

    <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>

    <button class="nav-button prev" aria-label="Предыдущий слайд">&#10094;</button>
    <button class="nav-button next" aria-label="Следующий слайд">&#10095;</button>

    <div class="credits">С Новым Годом!</div>

    ${audio ? `
      <div id="hint" class="visible">Если музыка не стартовала — нажмите ▶</div>
      <div id="start-overlay" class="start-overlay" aria-live="polite">
        <div id="start-card">
          <h2>Нажмите, чтобы начать</h2>
          <p>На iPhone и других мобильных браузерах музыка обычно не может стартовать автоматически — нужен тап.</p>
          <div id="start-actions">
            <button id="start-sound" class="start-btn">▶ включить звук</button>
            <button id="start-nosound" class="start-btn secondary">Начать без звука</button>
          </div>
          <div id="start-error"></div>
          <div id="native-audio-fallback" class="native-audio-fallback">
            <div class="native-audio-note">Если встроенный просмотрщик блокирует запуск через кнопку, нажмите <b>Play</b> на плеере ниже:</div>
            <div id="native-audio-slot"></div>
            <div class="native-audio-hint">Подсказка: если iPhone в беззвучном режиме (переключатель сбоку), звук может быть выключен.</div>
          </div>
        </div>
      </div>
      <div id="sound-control">
        <button id="player-control" aria-label="Пауза/Воспроизведение">
          <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" style="display:none" viewBox="0 0 16 16">
            <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5m5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5"/>
          </svg>
          <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/>
          </svg>
        </button>
        <div id="sound-label">включить звук</div>
      </div>
    ` : ''}

  </div>

  ${audioPlayer}
  ${iosSilencePlayer}

  <script>
    (function(){
      try{ document.body.classList.add('js-ok'); }catch(e){}
      const slider = document.getElementById('slider');
      const slides = Array.from(document.querySelectorAll('.slide'));
      const prevButton = document.querySelector('.prev');
      const nextButton = document.querySelector('.next');
      const progressBar = document.getElementById('progress-bar');
      const flash = document.getElementById('flash');

      const music = document.getElementById('bg-music');
      const playerControl = document.getElementById('player-control');
      const iconPause = document.getElementById('icon-pause');
      const iconPlay = document.getElementById('icon-play');
      const hint = document.getElementById('hint');
      const soundLabel = document.getElementById('sound-label');
      const startOverlay = document.getElementById('start-overlay');
      const startSoundBtn = document.getElementById('start-sound');
      const startNoSoundBtn = document.getElementById('start-nosound');
      const startError = document.getElementById('start-error');
      const silence = document.getElementById('ios-silence');
      const nativeAudioFallback = document.getElementById('native-audio-fallback');
      const nativeAudioSlot = document.getElementById('native-audio-slot');

      // Remember original location of the music element so we can temporarily move it into the overlay (native controls fallback)
      const musicHome = music ? music.parentElement : null;
      const musicHomeNext = music ? music.nextSibling : null;

      const isIOS = (function(){
        const ua = navigator.userAgent || '';
        const iOS = /iP(hone|ad|od)/.test(ua);
        const iPadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        return iOS || iPadOS;
      })();

      let didUnlockHack = false;
      let audioCtx = null;

      function runIOSUnlockHack(){
        if (!isIOS) return;
        if (didUnlockHack) return;
        didUnlockHack = true;

        // 1) WebAudio: resume context + play a tiny silent buffer (helps "unlock" audio in some iOS WebViews)
        try{
          const AC = window.AudioContext || window.webkitAudioContext;
          if (AC){
            audioCtx = audioCtx || new AC();
            if (audioCtx.state === 'suspended'){
              audioCtx.resume().catch(() => {});
            }
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.value = 0;
            source.connect(gain);
            gain.connect(audioCtx.destination);
            source.start(0);
            source.stop(0.01);
          }
        } catch(e){}

        // 2) HTMLAudio: play a short silent loop (helps switch audio session category in some previewers)
        if (silence){
          try{
            silence.muted = false;
            silence.volume = 0;
            silence.play().catch(() => {});
          } catch(e){}
        }
      }

      function restoreMusicHome(){
        if (!music || !musicHome) return;
        if (music.parentElement === musicHome) return;
        try{
          if (musicHomeNext){
            musicHome.insertBefore(music, musicHomeNext);
          } else {
            musicHome.appendChild(music);
          }
        } catch(e){}
      }

      function enableNativeAudioFallback(){
        if (!nativeAudioFallback || !music) return;
        nativeAudioFallback.classList.add('visible');
        try { music.controls = true; } catch(e){}
        if (nativeAudioSlot && music.parentElement !== nativeAudioSlot){
          try { nativeAudioSlot.appendChild(music); } catch(e){}
        }
      }

      const prefersReducedMotion = (function(){
        try { return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }
        catch(e){ return false; }
      })();

      const mode = (slider && slider.dataset && slider.dataset.transitionMode) ? slider.dataset.transitionMode : 'fade';
      const transitions = ['fade','dissolve','blur-fade','slide','zoom-cross','film-cut','polaroid-flip'];

      let currentSlide = 0;
      let timerNext = null;
      let timerFadeStart = null;
      let timerEnd = null;
      let fadeRaf = null;

      const normalSlideMs = Math.round(${slideDurationSeconds} * 1000);
      const lastSlideMs = 10000;
      const fadeStartOnLastMs = 3000; // когда последний кадр стоит 3 секунды
      // fade duration is the remaining time on the last slide

      const transDurMs = prefersReducedMotion ? 1 : 900;

      function isLast(index){ return index >= slides.length - 1; }

      function clearTimers(){
        if (timerNext) clearTimeout(timerNext);
        if (timerFadeStart) clearTimeout(timerFadeStart);
        if (timerEnd) clearTimeout(timerEnd);
        timerNext = timerFadeStart = timerEnd = null;
        cancelFade();
      }

      function cancelFade(){
        if (fadeRaf){
          cancelAnimationFrame(fadeRaf);
          fadeRaf = null;
        }
      }

      function clamp01(v){ return Math.max(0, Math.min(1, v)); }

      function setVolume(v){
        if (!music) return;
        music.volume = clamp01(v);
      }

      function fadeVolumeTo(target, durationMs){
        if (!music) return;
        cancelFade();
        const startVol = clamp01(music.volume);
        const endVol = clamp01(target);
        const start = performance.now();
        const dur = Math.max(1, durationMs);

        function step(now){
          const t = Math.min(1, (now - start) / dur);
          const v = startVol + (endVol - startVol) * t;
          setVolume(v);
          if (t < 1){
            fadeRaf = requestAnimationFrame(step);
          } else {
            fadeRaf = null;
          }
        }
        fadeRaf = requestAnimationFrame(step);
      }

      function pickTransition(){
        if (prefersReducedMotion) return 'fade';
        if (mode === 'random'){
          return transitions[Math.floor(Math.random()*transitions.length)];
        }
        if (transitions.includes(mode)) return mode;
        return 'fade';
      }

      function assignKenBurnsIfNeeded(){
        if (!slider.classList.contains('kb-on')) return;
        if (prefersReducedMotion) return;

        const presets = [
          {fx:'-2%', fy:'-2%', tx:'2%', ty:'2%', fs:1.04, ts:1.15},
          {fx:'2%', fy:'-2%', tx:'-2%', ty:'2%', fs:1.05, ts:1.16},
          {fx:'-2%', fy:'2%', tx:'2%', ty:'-2%', fs:1.05, ts:1.16},
          {fx:'2%', fy:'2%', tx:'-2%', ty:'-2%', fs:1.04, ts:1.15},
          {fx:'0%', fy:'-3%', tx:'0%', ty:'3%', fs:1.05, ts:1.14},
          {fx:'-3%', fy:'0%', tx:'3%', ty:'0%', fs:1.05, ts:1.14},
          {fx:'0%', fy:'0%', tx:'0%', ty:'0%', fs:1.06, ts:1.18}
        ];

        slides.forEach((slide) => {
          const media = slide.querySelector('.media');
          if (!media) return;
          const p = presets[Math.floor(Math.random()*presets.length)];
          media.style.setProperty('--kb-from-x', p.fx);
          media.style.setProperty('--kb-from-y', p.fy);
          media.style.setProperty('--kb-to-x', p.tx);
          media.style.setProperty('--kb-to-y', p.ty);
          media.style.setProperty('--kb-from-scale', String(p.fs));
          media.style.setProperty('--kb-to-scale', String(p.ts));
        });
      }

      function startKenBurns(slide){
        if (!slider.classList.contains('kb-on')) return;
        if (prefersReducedMotion) return;
        const media = slide.querySelector('.media');
        if (!media) return;
        media.classList.remove('kb-anim');
        void media.offsetWidth;
        media.classList.add('kb-anim');
      }

      function resetProgressBar(){
        if (!progressBar) return;
        if (slides.length <= 1) {
          progressBar.classList.remove('animate');
          progressBar.style.width = '100%';
          return;
        }
        progressBar.classList.remove('animate');
        void progressBar.offsetWidth;
        progressBar.classList.add('animate');
      }

      function setSlideSecondsForIndex(index){
        const sec = isLast(index) ? 10 : ${slideDurationSeconds};
        slider.style.setProperty('--slideSec', String(sec));
      }

      function cleanupTransientClasses(slide){
        slide.classList.remove('entering','leaving');
        for (const t of transitions){
          slide.classList.remove('tr-'+t);
        }
      }

      function fireFlash(){
        if (!flash || prefersReducedMotion) return;
        flash.classList.remove('fire');
        void flash.offsetWidth;
        flash.classList.add('fire');
      }

      function updateNavButtons(){
        if (!prevButton || !nextButton) return;
        prevButton.disabled = (currentSlide <= 0);
        nextButton.disabled = (currentSlide >= slides.length - 1);
      }

      function updatePlayerUI(){
        if (!music || !iconPause || !iconPlay) return;
        const paused = music.paused;

        iconPause.style.display = paused ? 'none' : 'block';
        iconPlay.style.display = paused ? 'block' : 'none';

        // Label and hint show when paused
        if (soundLabel){
          soundLabel.classList.toggle('hidden', !paused);
        }
        if (hint){
          hint.classList.toggle('visible', paused);
        }
      }

      // Called when we enter the LAST slide: schedule fade-out and ending
      function scheduleLastSlideEnding(){
        // The last slide must stay for 10 seconds total,
        // music starts fading after 3 seconds on the last slide.
        const lastStart = performance.now();
        const lastEndAt = lastStart + lastSlideMs;

        // 1) Fade start
        timerFadeStart = setTimeout(() => {
          if (!music) return;

          // remaining time to end determines fade duration
          const now = performance.now();
          const remaining = Math.max(0, lastEndAt - now);

          // start fading only if there's time
          if (remaining > 0){
            // Even if audio is paused, we still reduce volume so it won't "blast" if user starts late.
            // This matches "угасает" behavior at the end.
            fadeVolumeTo(0, remaining);
          }
        }, fadeStartOnLastMs);

        // 2) End show (do NOT loop)
        timerEnd = setTimeout(() => {
          // Ensure volume at 0 at the end, without an audible "cut"
          if (music){
            setVolume(0);
            // pause at 0 volume (inaudible)
            try { music.pause(); } catch(e){}
            updatePlayerUI();
          }
          // stop the iOS silent helper (if it was used)
          if (silence){
            try { silence.pause(); } catch(e){}
          }
          // Keep last slide on screen. Disable "next".
          updateNavButtons();
          if (nextButton) nextButton.disabled = true;
          // stop progress bar animation (optional): keep it full
          if (progressBar){
            progressBar.classList.remove('animate');
            progressBar.style.width = '100%';
          }
        }, lastSlideMs);
      }

      function scheduleAutoAdvance(){
        clearTimers();
        updateNavButtons();
        setSlideSecondsForIndex(currentSlide);
        resetProgressBar();
        startKenBurns(slides[currentSlide]);

        if (slides.length === 0) return;

        if (isLast(currentSlide)){
          scheduleLastSlideEnding();
          return;
        }

        // Schedule next slide (single run)
        timerNext = setTimeout(() => {
          goTo(currentSlide + 1, pickTransition(), true);
        }, normalSlideMs);
      }

      function showSlide(index, transition){
        if (slides.length === 0) return;

        // Same slide -> just reset timers/progress
        if (index === currentSlide){
          scheduleAutoAdvance();
          return;
        }

        const prev = slides[currentSlide];
        const next = slides[index];

        cleanupTransientClasses(prev);
        cleanupTransientClasses(next);

        const trClass = 'tr-' + transition;

        prev.classList.remove('active');
        prev.classList.add('leaving', trClass);

        next.classList.add('active', 'entering', trClass);

        if (transition === 'film-cut') fireFlash();

        // Ensure Ken Burns restarts on entering slide
        startKenBurns(next);

        // After transition, cleanup
        window.setTimeout(() => {
          cleanupTransientClasses(prev);
          cleanupTransientClasses(next);
          prev.classList.remove('active');
        }, transDurMs + 60);

        currentSlide = index;
        scheduleAutoAdvance();
      }

      function goTo(index, transition, isAuto){
        if (index < 0 || index >= slides.length) return;

        // If user navigates away from last slide, restore volume and cancel fade
        const leavingLast = isLast(currentSlide) && !isLast(index);
        if (leavingLast && music){
          cancelFade();
          setVolume(1);
        }

        showSlide(index, transition || pickTransition());
      }

      function handleManualNavigation(offset){
        const nextIdx = currentSlide + offset;
        if (nextIdx < 0 || nextIdx >= slides.length) return;
        goTo(nextIdx, pickTransition(), false);
      }

      function togglePlayPause(){
        if (!music) return;

        if (music.paused){
          // iOS/WebView: attempt to unlock audio output before playing.
          runIOSUnlockHack();

          // If the user enables sound late on the last slide, volume might already be low due to fade-out schedule.
          // It's expected; still try to play.
          music.play().catch(() => {/* ignored */});
        } else {
          music.pause();
        }
      }

      // Controls
      nextButton && nextButton.addEventListener('click', () => handleManualNavigation(1));
      prevButton && prevButton.addEventListener('click', () => handleManualNavigation(-1));

      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') handleManualNavigation(1);
        if (e.key === 'ArrowLeft') handleManualNavigation(-1);
        if (e.key === ' ' && music){
          e.preventDefault();
          togglePlayPause();
        }
      });

      if (music){
        // Start at full volume (we may fade out at the end)
        setVolume(1);

        music.addEventListener('play', () => {
          updatePlayerUI();
          // If user started playback via native controls (fallback), start the slideshow.
          if (!started && !starting){
            restoreMusicHome();
            hideStartOverlay();
            beginShow();
          }
        });
        music.addEventListener('pause', updatePlayerUI);

        if (playerControl){
          playerControl.addEventListener('click', togglePlayPause);
        }

        updatePlayerUI();
      }


      // Init
      assignKenBurnsIfNeeded();
      updateNavButtons();
      setSlideSecondsForIndex(0);

      // Don't start the slideshow timers until audio is allowed (mobile Safari requires a tap).
      if (progressBar){
        progressBar.classList.remove('animate');
        progressBar.style.width = '0%';
      }

      let started = false;
      let starting = false;

      function beginShow(){
        if (started) return;
        started = true;

        // If we temporarily moved the <audio> element into the overlay, restore it back.
        restoreMusicHome();
        if (nativeAudioFallback) nativeAudioFallback.classList.remove('visible');

        if (startOverlay) startOverlay.classList.remove('visible');
        // Start normal flow from the current slide (0)
        scheduleAutoAdvance();
        updateNavButtons();
      }

      function showStartOverlay(message){
        if (startOverlay) startOverlay.classList.add('visible');
        if (startError) startError.textContent = message || '';
      }

      function hideStartOverlay(){
        if (startOverlay) startOverlay.classList.remove('visible');
        if (startError) startError.textContent = '';
      }

      function startWithSound(){
        if (started || starting) return;
        starting = true;

        if (!music){
          starting = false;
          hideStartOverlay();
          beginShow();
          return;
        }

        if (startError) startError.textContent = '';

        // Ensure volume is restored (in case user reloaded on the last slide state)
        cancelFade();
        setVolume(1);

        try { music.currentTime = 0; } catch(e){}
        try { music.muted = false; } catch(e){}

        // iOS/WebView: try to unlock audio output first (still within the same user gesture)
        runIOSUnlockHack();

        const p = music.play();
        if (p && typeof p.then === 'function'){
          p.then(() => {
            starting = false;
            updatePlayerUI();
            hideStartOverlay();
            beginShow();
          }).catch(() => {
            starting = false;

            // Some iOS "embedded viewers" (Quick Look / in‑app preview / messengers) block JS‑started audio.
            // Show a fallback with native <audio controls> so the user can press Play directly.
            enableNativeAudioFallback();
            showStartOverlay('Не удалось включить звук этой кнопкой. Такое бывает во встроенном просмотрщике iOS или внутри мессенджера. Попробуйте: 1) нажмите Play на плеере ниже, 2) либо откройте файл в Safari.');
            updatePlayerUI();
          });
        } else {
          starting = false;
          updatePlayerUI();
          hideStartOverlay();
          beginShow();
        }
      }

      function startWithoutSound(){
        if (started || starting) return;
        starting = true;

        if (music){
          try { music.pause(); } catch(e){}
          updatePlayerUI();
        }

        starting = false;
        hideStartOverlay();
        beginShow();
      }

      // Bind overlay buttons (use only one gesture type to avoid double-firing)
      if (startSoundBtn){
        startSoundBtn.addEventListener('touchend', (e) => { e.preventDefault(); startWithSound(); }, {passive:false});
        startSoundBtn.addEventListener('pointerup', (e) => { e.preventDefault(); startWithSound(); }, {passive:false});
        startSoundBtn.addEventListener('click', (e) => { e.preventDefault(); startWithSound(); }, {passive:false});
      }
      if (startNoSoundBtn){
        startNoSoundBtn.addEventListener('touchend', (e) => { e.preventDefault(); startWithoutSound(); }, {passive:false});
        startNoSoundBtn.addEventListener('pointerup', (e) => { e.preventDefault(); startWithoutSound(); }, {passive:false});
        startNoSoundBtn.addEventListener('click', (e) => { e.preventDefault(); startWithoutSound(); }, {passive:false});
      }

      // Try to autoplay where it's allowed (desktop or if the user previously granted permission).
      // If autoplay is blocked, show the start overlay and wait for a tap.
      if (music){
        const ap = music.play();
        if (ap && typeof ap.then === 'function'){
          ap.then(() => {
            updatePlayerUI();
            beginShow();
          }).catch(() => {
            try { music.pause(); } catch(e){}
            updatePlayerUI();
            showStartOverlay();
          });
        } else {
          beginShow();
        }
      } else {
        beginShow();
      }
    })();
  <\/script>
</body>
</html>`;
      }

      function downloadTextFile(filename, content){
        const blob = new Blob([content], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // --- Handlers ---
      async function addImageFiles(fileList){
        const files = Array.from(fileList || []).filter(f => f && f.type && f.type.startsWith('image/'));
        if (files.length === 0) return;

        setBusy(true);
        try{
          const promises = files.map(async (file) => {
            const dataUrl = await readFileAsDataURL(file);
            return { id: makeId(file.name), name: file.name, dataUrl };
          });
          const newImages = await Promise.all(promises);
          state.images = state.images.concat(newImages);
          renderGrid();
        } catch(err){
          console.error(err);
          alert('Не удалось прочитать один или несколько файлов изображений.');
        } finally {
          setBusy(false);
        }
      }

      async function setAudioFile(file){
        if (!file) return;
        setBusy(true);
        try{
          const dataUrl = await readFileAsDataURL(file);
          state.audio = { name: file.name, type: file.type || 'audio/mpeg', dataUrl };
          audioStatus.style.display = 'block';
          audioStatus.textContent = 'Загружено: ' + state.audio.name;
        } catch(err){
          console.error(err);
          alert('Не удалось прочитать аудиофайл.');
        } finally {
          setBusy(false);
        }
      }

      imageUpload.addEventListener('change', (e) => {
        addImageFiles(e.target.files);
        e.target.value = '';
      });

      audioUpload.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files && files.length > 0) setAudioFile(files[0]);
        e.target.value = '';
      });

      durationRange.addEventListener('input', () => {
        state.slideDuration = Number(durationRange.value || 5);
        durationValue.textContent = state.slideDuration + ' сек.';
      });

      kenBurnsToggle.addEventListener('change', () => {
        state.kenBurns = !!kenBurnsToggle.checked;
      });

      transitionSelect.addEventListener('change', () => {
        state.transition = String(transitionSelect.value || 'fade');
      });

      // Drag & drop area for image files
      dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
      dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
      dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');
        if (e.dataTransfer && e.dataTransfer.files){
          addImageFiles(e.dataTransfer.files);
        }
      });

      clearAllBtn.addEventListener('click', () => {
        if (!confirm('Очистить все загруженные изображения и музыку?')) return;
        state.images = [];
        state.audio = null;
        state.lastGeneratedHtml = null;
        audioStatus.style.display = 'none';
        audioStatus.textContent = '';
        renderGrid();
        setBusy(false);
      });

      generateBtn.addEventListener('click', () => {
        if (state.images.length === 0){
          alert('Пожалуйста, загрузите хотя бы одно изображение.');
          return;
        }
        setBusy(true);
        try{
          const slideSeconds = Number(state.slideDuration || 5);
          const imgs = state.images.map(x => x.dataUrl);
          const html = generatePresentationHtml(
            imgs,
            state.audio,
            slideSeconds,
            state.kenBurns,
            state.transition
          );
          state.lastGeneratedHtml = html;
          previewBtn.disabled = false;
          downloadTextFile('new-year-presentation.html', html);
        } catch(err){
          console.error(err);
          alert('Произошла ошибка при создании файла. Пожалуйста, попробуйте снова.');
        } finally {
          setBusy(false);
        }
      });

      previewBtn.addEventListener('click', () => {
        if (!state.lastGeneratedHtml) return;
        const blob = new Blob([state.lastGeneratedHtml], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank', 'noopener,noreferrer');
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
      });

      // Initial render
      renderGrid();
      durationValue.textContent = state.slideDuration + ' сек.';
      setBusy(false);
    })();
  </script>
</body>
</html>
